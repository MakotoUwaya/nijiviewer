# Loro Flow Sync - マルチウィンドウ同期

この実装は、Loro CRDT を使用して複数のブラウザタブ/ウィンドウ間で React Flow ダイアグラムのリアルタイム同期を提供します。

## 機能

- **リアルタイム同期**: 一つのタブで行った変更が、他のすべてのタブに即座に反映されます
- **永続化ストレージ**: データは localStorage に保存され、ページリロード時に復元されます
- **タブ間通信**: 最適な同期のために localStorage イベントと BroadcastChannel の両方を使用します
- **ピア数カウント**: 現在接続されているタブ/ウィンドウの数を表示します
- **デバッグパネル**: 同期ステータスとピア数に関するリアルタイム情報を表示します

## マルチウィンドウ同期のテスト方法

1. **開発サーバーを起動**:

   ```bash
   npm run dev
   ```

2. **フローサンプルページを開く**:
   `http://localhost:3001/flow-sample` にアクセスします

3. **複数のタブ/ウィンドウを開く**:

   - 同じ URL を複数のブラウザタブで開く
   - または複数のブラウザウィンドウで開く
   - 異なるブラウザ間でもテストできます

4. **同期をテスト**:

   - **ノードの追加**: 一つのタブで「Add Node」をクリックし、他のタブに表示されることを確認
   - **ノードの移動**: 一つのタブでノードをドラッグし、他のタブでも移動することを確認
   - **ノードの接続**: ノード間にエッジを作成し、接続が同期されることを確認
   - **要素の削除**: ノード/エッジを選択して削除し、変更が反映されることを確認

5. **同期ステータスの監視**:
   - 右下角のデバッグパネルを確認
   - より多くのタブを開くとピア数が増加することを確認
   - 変更が発生した際に「Last Sync」タイムスタンプが更新されることを確認

## 技術的実装

### コンポーネント

- **LoroFlowSync**: Loro CRDT ドキュメントと同期を管理するメインフック
- **DebugPanel**: リアルタイム同期情報を表示
- **Flow Sample Page**: React Flow 統合のデモページ

### 同期方法

1. **Loro CRDT**: 一貫した状態管理のための競合フリー複製データ型
2. **localStorage**: 永続化ストレージと storage イベント経由のタブ間同期
3. **BroadcastChannel**: 即座の更新のためのタブ間リアルタイム通信
4. **ピア追跡**: クリーンアップ機能付きの localStorage を使用したシンプルなピア数カウント

### 主要機能

- **競合解決**: Loro CRDT が同時編集を自動的に処理
- **オフラインサポート**: 変更はローカルに保存され、タブが再接続時に同期
- **パフォーマンス**: 最小限のデータ転送で効率的な更新
- **エラーハンドリング**: 適切なフォールバックとエラー回復

## トラブルシューティング

- **同期が機能しない**: ブラウザコンソールでエラーを確認してください
- **同期が遅い**: BroadcastChannel が即座同期を提供し、localStorage イベントがバックアップとして機能します
- **データ損失**: localStorage が有効で容量が満杯でないか確認してください
- **ピア数が間違っている**: ピアは 10 秒間の非アクティブ後にクリーンアップされます

## ブラウザ互換性

- BroadcastChannel をサポートするモダンブラウザ
- 古いブラウザでは localStorage イベントにフォールバック
- Loro CRDT には WebAssembly サポートが必要
